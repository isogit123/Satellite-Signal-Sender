<html>
	<head></head>
	<body>
		<canvas id="output"></canvas>
		<canvas id="outputnew" style="display: none;"></canvas>
		
    <video id="video" style="display: none;">Your browser does not support the video tag.</video>
<script src="/opencv.js"></script>
<script src="/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script>
  	var Module = {
    wasmBinaryFile: '/opencv_js.wasm',
    _main: function() {}
  };
    var socket = io();
      rect = null;
   socket.on('roi', function(coord){
   	if(coord == null)
   rect = null;
   else
rect = new cv.Rect(coord.x1, coord.y1, coord.x2, coord.y2);
});
    
    let width = 768;
let height = 0;

// whether streaming video from the camera.
let streaming = false;

let video = document.getElementById("video");
let stream = null;
let vc = null;
canvas = document.getElementById('output');
canvas2 = document.getElementById('outputnew');
function startCamera() {
  if (streaming) return;
  navigator.mediaDevices.getUserMedia({
video: { facingMode: "environment"},
 audio: false
})
    .then(function(s) {
    stream = s;
    video.srcObject = s;
    video.play();
  })
    .catch(function(err) {
    console.log("An error occured! " + err);
  });

  video.addEventListener("canplay", function(ev){
  	cv['onRuntimeInitialized']=() => {
    if (!streaming) {
      width = video.videoHeight;
      height = video.videoWidth;
      video.setAttribute("width", width);
      video.setAttribute("height", height);
      canvas.setAttribute("width", width);
      canvas.setAttribute("height", height);
      streaming = true;
      vc = new cv.VideoCapture(video);
    }
    startVideoProcessing();
    };
  }, false);
  
}

let src = null;
let dstC1 = null;
function startVideoProcessing() {
  if (!streaming) { console.warn("Please startup your webcam"); return; }
  stopVideoProcessing();
  src = new cv.Mat(height, width, cv.CV_8UC4);
  dstC1 = new cv.Mat(height, width, cv.CV_8UC1);
  process = setInterval(processVideo, 200);
}


function processVideo() {
  vc.read(src);
  let result = gray(src);
  if(rect !== null)
  {
  	resultRoi = result.roi(rect);
cv.imshow("outputnew", resultRoi);
  socket.emit('image', {
img: canvas2.toDataURL("image/webp")
});
}
else
socket.emit('image', {
img: canvas.toDataURL("image/webp")
});
  cv.imshow("output", result);
}

function stopVideoProcessing() {
  if (src != null && !src.isDeleted()) src.delete();
  if (dstC1 != null && !dstC1.isDeleted()) dstC1.delete();
}

function stopCamera() {
  if (!streaming) return;
  stopVideoProcessing();
  document.getElementById("output").getContext("2d").clearRect(0, 0, width, height);
  video.pause();
  video.srcObject=null;
  stream.getVideoTracks()[0].stop();
  streaming = false;
  clearInterval(process);
}

function gray(src) {
  cv.cvtColor(src, dstC1, cv.COLOR_RGBA2GRAY);
  return dstC1;
}
startCamera();
</script>
</body>
</html>